// +build ignore
package main

import (
	"bytes"
	"fmt"
	"io/ioutil"
	"log"
	"os/exec"
	"strings"
	"time"

	"github.com/grafana/tanka/pkg/kubernetes/client"
	"github.com/grafana/tanka/pkg/kubernetes/resources"
	"github.com/sanity-io/litter"
)

func main() {
	log.SetFlags(0)

	var store resources.Store
	s := run("kubectl", "api-resources", "-o=wide")
	if err := client.UnmarshalTable(s, &store); err != nil {
		log.Fatalln(err)
	}

	ver := strings.TrimSpace(run("kubectl", "version", "--short"))

	litter.Config.HomePackage = "resources"

	tmpl := `// Code generated by go generate; DO NOT EDIT.
// This file was generated by robots at
// %s
// by parsing 'kubectl api-resources'.
// %s

package resources

var StaticStore = %s
`

	content := fmt.Sprintf(tmpl, time.Now(), strings.Replace(ver, "\n", "\n// ", -1), litter.Sdump(store))
	if err := ioutil.WriteFile("static_gen.go", []byte(content), 0644); err != nil {
		log.Fatalln(err)
	}
}

func run(a string, b ...string) string {
	var buf bytes.Buffer
	cmd := exec.Command(a, b...)
	cmd.Stdout = &buf

	if err := cmd.Run(); err != nil {
		log.Fatalln(err)
	}

	return buf.String()
}
